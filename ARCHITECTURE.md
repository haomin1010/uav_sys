# 系统架构详解

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        决策源层 (Decision Sources)                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────┐         ┌──────────┐         ┌──────────┐            │
│  │ RL平台   │         │ 中央算力  │         │ 人类控制  │            │
│  │          │         │ (AirSim)  │         │  (RC)    │            │
│  │ 优先级100│         │ 优先级150 │         │ 优先级200│            │
│  └────┬─────┘         └────┬─────┘         └────┬─────┘            │
│       │                    │                    │                    │
└───────┼────────────────────┼────────────────────┼────────────────────┘
        │                    │                    │
        │ /rl/decision      │ /central/decision  │ 自动检测
        │ _output           │ _output            │ (MAVROS)
        ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        适配器层 (Adapters)                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────┐         ┌──────────┐         ┌──────────┐            │
│  │    RL    │         │  AirSim  │         │   PX4    │            │
│  │  Adapter │         │  Adapter │         │  Adapter │            │
│  └────┬─────┘         └────┬─────┘         └────┬─────┘            │
│       │                    │                    │                    │
│       │ CommandMsg        │ CommandMsg         │ CommandMsg         │
│       │                    │                    │                    │
└───────┼────────────────────┼────────────────────┼────────────────────┘
        │                    │                    │
        │ /uav/source/rl/cmd │ /uav/source/       │ /uav/source/
        │                    │ central/cmd        │ human/cmd
        ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      仲裁层 (Arbiter)                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌───────────────────────────────────────────────────────────┐      │
│  │                     Arbiter Node                          │      │
│  │                                                           │      │
│  │  • 接收三路命令                                            │      │
│  │  • 评估优先级、新鲜度、有效性                              │      │
│  │  • 选择生效源（支持抢占）                                  │      │
│  │  • 防抖动处理                                             │      │
│  │  • 心跳超时检测                                           │      │
│  └─────────────────────────┬─────────────────────────────────┘      │
│                            │                                         │
│                            │ /uav/authoritative_cmd                 │
│                            │                                         │
└────────────────────────────┼─────────────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      同步层 (Synchronizer)                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌───────────────────────────────────────────────────────────┐      │
│  │                  Synchronizer Node                        │      │
│  │                                                           │      │
│  │  • 接收权威命令                                            │      │
│  │  • 转发给所有平台                                          │      │
│  │  • 监控平台状态                                            │      │
│  │  • 检查同步状态                                            │      │
│  └─────────────────────────┬─────────────────────────────────┘      │
│                            │                                         │
│                            │ /uav/sync/cmd                          │
│                            │                                         │
└────────────────────────────┼─────────────────────────────────────────┘
                             │
                ┌────────────┴────────────┐
                │                         │
                ▼                         ▼                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      执行层 (Execution)                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────┐         ┌──────────┐         ┌──────────┐            │
│  │    RL    │         │  AirSim  │         │   PX4    │            │
│  │  Adapter │         │  Adapter │         │  Adapter │            │
│  │          │         │          │         │          │            │
│  │  执行+显示│         │  执行仿真 │         │  执行真机│            │
│  └────┬─────┘         └────┬─────┘         └────┬─────┘            │
│       │                    │                    │                    │
│       ▼                    ▼                    ▼                    │
│  /rl/visualization   AirSim API          MAVROS Topics              │
│       │                    │                    │                    │
│       ▼                    ▼                    ▼                    │
│   RL展示界面          仿真无人机            真实/SITL无人机           │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

## 核心组件详解

### 1. Arbiter（仲裁器）

**职责**：
- 接收并缓存来自各决策源的最新命令
- 根据优先级和时效性选择当前生效的命令
- 支持高优先级抢占低优先级
- 防抖动和心跳检测

**核心算法**：
```python
def evaluate():
    # 1. 收集所有有效候选
    candidates = []
    for source in sources:
        if valid(source.cmd) and not_expired(source.cmd):
            candidates.append(source)
    
    # 2. 按优先级排序
    candidates.sort(by=priority, desc=True)
    
    # 3. 判断是否切换
    if candidates[0].priority > current_source.priority:
        switch_to(candidates[0])  # 高优先级抢占
    elif timeout(current_source):
        fallback_to(candidates[0])  # 回退
```

**关键特性**：
- **优先级抢占**：高优先级命令到达时立即切换
- **防抖窗口**：200ms内避免频繁切换（可配置）
- **心跳超时**：2秒内无更新则认为源失联
- **命令过期**：每个命令带有效期，过期自动丢弃

### 2. Synchronizer（同步器）

**职责**：
- 接收仲裁后的权威命令
- 转发给所有适配器
- 监控各平台状态
- 检查同步情况

**工作流程**：
1. 订阅 `/uav/authoritative_cmd`
2. 立即转发到 `/uav/sync/cmd`
3. 收集各平台状态反馈
4. 发布同步状态报告

**状态监控**：
- 平台在线检测（2秒超时）
- 位置数据有效性
- 整体同步状态

### 3. Adapters（适配器）

#### 3.1 RL Adapter

**入站**：
- 订阅：`/rl/decision_output`
- 格式：`{"action": [vx, vy, vz, yaw_rate]}`
- 转换为：CommandMsg（source_id="rl", priority=100）
- 发布到：`/uav/source/rl/cmd`

**出站**：
- 订阅：`/uav/sync/cmd`
- 转换为RL可视化格式
- 发布到：`/rl/visualization_cmd`

#### 3.2 AirSim Adapter

**入站**：
- 订阅：`/central/decision_output`
- 格式：`{"type": "position", "position": {...}}`
- 转换为：CommandMsg（source_id="central", priority=150）
- 发布到：`/uav/source/central/cmd`

**出站**：
- 订阅：`/uav/sync/cmd`
- 调用AirSim API执行
  - 速度：`moveByVelocityAsync()`
  - 位置：`moveToPositionAsync()`
  - 轨迹：`moveOnPathAsync()`

#### 3.3 PX4 Adapter

**入站**：
- 监听：MAVROS RC/手动控制话题
- 检测人类控制信号（阈值判断）
- 转换为：CommandMsg（source_id="human", priority=200）
- 发布到：`/uav/source/human/cmd`

**出站**：
- 订阅：`/uav/sync/cmd`
- 发布到MAVROS话题
  - 速度：`/mavros/setpoint_velocity/cmd_vel`
  - 位置：`/mavros/setpoint_position/local`

## 数据流示例

### 场景：RL控制中被中央算力抢占

```
时间线 | RL平台 | 中央算力 | 仲裁器 | 执行
─────┼────────┼──────────┼────────┼──────────────
T0   | 速度cmd→RL_Adapter→ [RL生效] → 三平台执行RL命令
T1   | 速度cmd→           → [RL生效] → 三平台执行RL命令
T2   |        → 位置cmd→Central_Adapter→ [评估]
T3   |        →          → [切换到Central] → 三平台执行Central命令
T4   | 速度cmd→           → [Central生效] → 三平台执行Central命令
     | (RL仍发送但被抢占)
```

### 场景：人类紧急接管

```
时间线 | 状态 | 仲裁器决策 | 原因
─────┼──────┼────────────┼──────────────────
T0   | RL控制 | RL生效 | 仅RL有命令
T1   | RL控制 | RL生效 | RL持续发送
T2   | 人类操作遥控器 | 人类立即生效 | 最高优先级，立即抢占
T3   | 人类控制 | 人类生效 | 保持人类控制
T4   | 人类停止操作 | 回退到RL | 人类命令超时
```

## 消息格式标准

### CommandMsg结构

```python
{
  "header": {
    "timestamp": float,      # UNIX时间戳（秒）
    "source_id": str,        # "rl" | "central" | "human"
    "seq": int               # 序列号
  },
  "meta": {
    "priority": int,         # 0-255，数值越大优先级越高
    "mode": str,             # "velocity" | "position" | "trajectory"
    "expires_at": float      # 过期时间戳
  },
  "body": {
    "velocity": {...},       # 三选一
    "setpoint": {...},       # 三选一
    "trajectory": [...]      # 三选一
  }
}
```

## 优先级策略

| 决策源 | 优先级 | 使用场景 | 抢占规则 |
|--------|--------|----------|----------|
| 人类 | 200 | 紧急控制、手动操作 | 立即抢占所有 |
| 中央算力 | 150 | 全局任务规划 | 抢占RL，被人类抢占 |
| RL | 100 | 自主飞行 | 被所有抢占，失联时回退目标 |

## 容错机制

### 1. 命令过期
- 每个命令带 `expires_at` 时间戳
- 过期命令自动丢弃
- 建议：实时命令0.5秒，规划命令1-2秒

### 2. 心跳超时
- 2秒内无新命令视为源失联
- 自动回退到次优先级源
- 全部失联时发布安全悬停

### 3. 防抖动
- 200ms抑制窗口
- 避免相同优先级源频繁切换
- 高优先级仍可立即抢占

### 4. 安全悬停
- 无有效命令时自动触发
- 速度设为(0,0,0,0)
- 优先级255（最高）

## 性能特性

- **延迟**：端到端 < 50ms（20Hz控制频率）
- **吞吐**：支持100Hz命令输入
- **可靠性**：心跳检测 + 命令过期保证
- **可扩展**：易于添加新决策源

## 部署建议

### 单机部署
- 开发测试阶段
- 所有节点运行在同一主机
- ROS2自动发现

### 分布式部署
- RL平台：独立计算节点
- AirSim：高性能仿真节点
- PX4：边缘计算/机载电脑
- 仲裁器+同步器：低延迟中心节点

### 时间同步
- 使用NTP（精度~ms级）
- 推荐PTP（精度~μs级）
- 本地测试可忽略

## 扩展方向

1. **多机编队**：每架无人机独立仲裁器
2. **新决策源**：添加视觉避障、GPS导航等
3. **轨迹预测**：提前插值平滑轨迹
4. **状态估计融合**：多源位置数据融合
5. **日志回放**：rosbag记录+回放分析

